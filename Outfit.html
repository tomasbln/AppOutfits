<!-- ARCHIVO: index.html -->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Generador de Outfits</title>
  
  <!-- PWA Meta Tags -->
  <meta name="description" content="Genera outfits perfectos basados en im√°genes de referencia">
  <meta name="theme-color" content="#667eea">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Outfit Gen">
  
  <!-- PWA Icons -->
  <link rel="icon" type="image/png" sizes="32x32" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üëî</text></svg>">
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üëî</text></svg>">
  
  <!-- Manifest -->
  <link rel="manifest" href="manifest.json">
  
  <style>
    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      text-align: center; 
      padding: 5px; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      margin: 0;
      touch-action: manipulation;
    }
    
    .container {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 15px;
      padding: 15px;
      max-width: 800px;
      margin: 0 auto;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
      backdrop-filter: blur(10px);
    }
    
    .bloque { 
      margin: 10px; 
      display: inline-block; 
      background: rgba(255, 255, 255, 0.8);
      padding: 12px;
      border-radius: 10px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
      width: calc(50% - 20px);
      min-width: 280px;
    }
    
    img { 
      max-width: 80px; 
      max-height: 80px; 
      margin: 3px; 
      border: 2px solid #ddd; 
      border-radius: 8px;
      transition: all 0.2s ease;
      cursor: pointer;
    }
    
    img:hover, img:active {
      transform: scale(1.05);
      border-color: #667eea;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }
    
    #resultado { 
      margin: 20px 0; 
      background: rgba(255, 255, 255, 0.95);
      padding: 15px;
      border-radius: 12px;
      box-shadow: 0 6px 24px rgba(0,0,0,0.1);
    }
    
    .outfit-item { 
      display: inline-block; 
      margin: 8px;
      background: white;
      padding: 12px;
      border-radius: 10px;
      box-shadow: 0 3px 12px rgba(0,0,0,0.1);
      transition: transform 0.2s ease;
    }
    
    .outfit-item:hover {
      transform: translateY(-2px);
    }
    
    .outfit-item img {
      max-width: 120px;
      max-height: 120px;
    }
    
    button {
      background: linear-gradient(45deg, #667eea, #764ba2);
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 16px;
      border-radius: 25px;
      cursor: pointer;
      transition: all 0.2s ease;
      margin: 8px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      touch-action: manipulation;
      min-height: 44px; /* iOS tap target */
    }
    
    button:hover, button:active {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.3);
    }
    
    button:active {
      transform: translateY(0);
    }
    
    .file-input {
      margin: 8px 0;
      padding: 8px;
      border: 2px dashed #ccc;
      border-radius: 8px;
      background: rgba(255,255,255,0.7);
      width: 100%;
      font-size: 14px;
    }
    
    .restrictions {
      background: rgba(255, 235, 59, 0.3);
      padding: 12px;
      border-radius: 10px;
      margin: 10px 0;
      border-left: 4px solid #ffc107;
      font-size: 14px;
    }
    
    h1 { 
      color: #333; 
      text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
      font-size: 24px;
      margin-bottom: 15px;
    }
    
    h2 {
      font-size: 20px;
      color: #444;
    }
    
    h3 { 
      color: #555;
      font-size: 16px;
      margin: 8px 0;
    }
    
    h4 {
      margin: 5px 0;
      font-size: 14px;
    }
    
    /* Responsive Design */
    @media (max-width: 768px) {
      .container { 
        padding: 10px; 
        margin: 5px; 
        border-radius: 10px;
      }
      
      .bloque { 
        display: block; 
        margin: 8px auto; 
        width: calc(100% - 16px);
        min-width: auto;
      }
      
      img { 
        max-width: 70px; 
        max-height: 70px; 
      }
      
      .outfit-item img {
        max-width: 100px;
        max-height: 100px;
      }
      
      button {
        padding: 10px 20px;
        font-size: 14px;
        width: calc(50% - 8px);
        min-width: 140px;
      }
      
      h1 { font-size: 20px; }
      h2 { font-size: 18px; }
    }
    
    @media (max-width: 480px) {
      .container {
        margin: 2px;
        border-radius: 8px;
      }
      
      button {
        width: calc(100% - 16px);
        margin: 4px 8px;
      }
      
      img { 
        max-width: 60px; 
        max-height: 60px; 
      }
    }
    
    /* Loading States */
    .loading {
      opacity: 0.7;
      pointer-events: none;
    }
    
    .loading::after {
      content: "‚è≥";
      margin-left: 8px;
    }
    
    /* Install Button */
    #install-prompt {
      display: none;
      background: rgba(76, 175, 80, 0.9);
      color: white;
      padding: 10px;
      border-radius: 8px;
      margin: 10px 0;
      cursor: pointer;
    }
    
    /* Offline Indicator */
    .offline-indicator {
      display: none;
      background: rgba(255, 152, 0, 0.9);
      color: white;
      padding: 8px;
      border-radius: 5px;
      margin: 5px 0;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div class="offline-indicator" id="offline-indicator">
    üì± Funcionando sin conexi√≥n
  </div>
  
  <div class="container">
    <h1>üëî Generador de Outfits</h1>
    
    <div id="install-prompt" onclick="installApp()">
      üì± Instalar como App - Toca aqu√≠
    </div>
    
    <div class="restrictions">
      <h4>‚ö†Ô∏è Restricciones:</h4>
      <p>Los archivos "Camb" de camisetas NO se pueden combinar con "mocho" y "sudad" de pantalones</p>
    </div>

    <div class="bloque">
      <h3>üëï Camisetas</h3>
      <input type="file" id="camisetas" multiple accept="image/*" class="file-input">
      <div id="preview-camisetas"></div>
    </div>
    <div class="bloque">
      <h3>üëñ Pantalones</h3>
      <input type="file" id="pantalones" multiple accept="image/*" class="file-input">
      <div id="preview-pantalones"></div>
    </div>
    <div class="bloque">
      <h3>üëü Zapatos</h3>
      <input type="file" id="zapatos" multiple accept="image/*" class="file-input">
      <div id="preview-zapatos"></div>
    </div>
    <div class="bloque">
      <h3>üì∏ Referencias</h3>
      <input type="file" id="referencias" multiple accept="image/*" class="file-input">
      <div id="preview-referencias"></div>
    </div>

    <br><br>
    <button id="generar">‚ú® Generar Outfit</button>
    <button id="resetear">üîÑ Reset Contador</button>

    <h2>üëî Outfit generado:</h2>
    <div id="resultado"></div>
  </div>

  <canvas id="canvas" style="display:none;"></canvas>

  <script>
    // Service Worker Registration
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
          .then(registration => console.log('SW registered'))
          .catch(error => console.log('SW registration failed'));
      });
    }

    // Install App Prompt
    let deferredPrompt;
    
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      document.getElementById('install-prompt').style.display = 'block';
    });
    
    function installApp() {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then((result) => {
          if (result.outcome === 'accepted') {
            document.getElementById('install-prompt').style.display = 'none';
          }
          deferredPrompt = null;
        });
      }
    }

    // Network Status
    function updateNetworkStatus() {
      const indicator = document.getElementById('offline-indicator');
      if (!navigator.onLine) {
        indicator.style.display = 'block';
      } else {
        indicator.style.display = 'none';
      }
    }

    window.addEventListener('online', updateNetworkStatus);
    window.addEventListener('offline', updateNetworkStatus);
    updateNetworkStatus();

    // Resto del c√≥digo del generador (mismo que antes)
    let cachedColors = {
      camisetas: [],
      pantalones: [],
      zapatos: [],
      referencias: []
    };

    let usageCounter = {
      camisetas: {},
      pantalones: {},
      zapatos: {}
    };

    let recentSelections = {
      camisetas: [],
      pantalones: [],
      zapatos: []
    };

    function getAverageColor(img, callback) {
      const canvas = document.getElementById('canvas');
      const ctx = canvas.getContext('2d');
      
      const MAX_SIZE = 100;
      let w = img.width;
      let h = img.height;
      if (w > h) {
        if (w > MAX_SIZE) { h *= MAX_SIZE / w; w = MAX_SIZE; }
      } else {
        if (h > MAX_SIZE) { w *= MAX_SIZE / h; h = MAX_SIZE; }
      }

      canvas.width = w;
      canvas.height = h;
      ctx.drawImage(img, 0, 0, w, h);

      const data = ctx.getImageData(0, 0, w, h).data;
      let r = 0, g = 0, b = 0, count = 0;

      for (let i = 0; i < data.length; i += 4) {
        r += data[i];
        g += data[i+1];
        b += data[i+2];
        count++;
      }

      r = Math.floor(r/count);
      g = Math.floor(g/count);
      b = Math.floor(b/count);

      callback([r, g, b]);
    }

    function euclidean(c1, c2) {
      return Math.sqrt(
        Math.pow(c1[0]-c2[0],2) +
        Math.pow(c1[1]-c2[1],2) +
        Math.pow(c1[2]-c2[2],2)
      );
    }

    function extractFileName(file) {
      return file.name.toLowerCase().replace(/\.[^/.]+$/, "");
    }

    function isValidCombination(camisetaName, pantalonName) {
      if (camisetaName.includes('camb')) {
        if (pantalonName.includes('mocho') || pantalonName.includes('sudad')) {
          return false;
        }
      }
      return true;
    }

    function pickBestMatching(items, refColor, category, excludeCondition = null) {
      if (items.length === 0) return null;
      
      let filteredItems = items;
      if (excludeCondition) {
        filteredItems = items.filter(item => !excludeCondition(item));
      }
      
      if (filteredItems.length === 0) return null;

      const usageCounts = filteredItems.map(item => usageCounter[category][item.fileName] || 0);
      const minUsage = Math.min(...usageCounts);
      const maxUsage = Math.max(...usageCounts);
      
      const shouldPrioritizeVariety = Math.random() < 0.75;
      
      let candidates;
      
      if (shouldPrioritizeVariety) {
        const threshold = minUsage + Math.floor((maxUsage - minUsage) / 3);
        candidates = filteredItems.filter(item => {
          const usage = usageCounter[category][item.fileName] || 0;
          return usage <= threshold;
        });
        
        if (candidates.length < 2) {
          candidates = filteredItems.filter(item => {
            const usage = usageCounter[category][item.fileName] || 0;
            return usage === minUsage;
          });
        }
      } else {
        const distances = filteredItems.map((item) => ({
          item: item,
          distance: euclidean(item.color, refColor),
          usageCount: usageCounter[category][item.fileName] || 0
        }));
        
        distances.sort((a, b) => {
          const usagePenalty = 50;
          const adjustedDistanceA = a.distance + (a.usageCount * usagePenalty);
          const adjustedDistanceB = b.distance + (b.usageCount * usagePenalty);
          return adjustedDistanceA - adjustedDistanceB;
        });
        
        const selectionSize = Math.min(Math.ceil(filteredItems.length * 0.6), filteredItems.length);
        candidates = distances.slice(0, selectionSize).map(d => d.item);
      }
      
      if (candidates.length === 0) {
        candidates = filteredItems;
      }
      
      let finalCandidates = candidates;
      if (candidates.length > 3 && recentSelections[category].length > 0) {
        const recentNames = recentSelections[category];
        finalCandidates = candidates.filter(item => 
          !recentNames.includes(item.fileName)
        );
        
        if (finalCandidates.length === 0) {
          finalCandidates = candidates;
        }
      }
      
      const randomChoice = finalCandidates[Math.floor(Math.random() * finalCandidates.length)];
      
      if (!usageCounter[category][randomChoice.fileName]) {
        usageCounter[category][randomChoice.fileName] = 0;
      }
      usageCounter[category][randomChoice.fileName]++;
      
      recentSelections[category].unshift(randomChoice.fileName);
      if (recentSelections[category].length > 2) {
        recentSelections[category].pop();
      }
      
      return randomChoice;
    }

    function processFiles(files, category, callback) {
      const results = [];
      let loaded = 0;

      if (files.length === 0) return callback([]);

      Array.from(files).forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = e => {
          const img = new Image();
          img.onload = () => {
            getAverageColor(img, color => {
              results[index] = {
                src: e.target.result,
                color: color,
                fileName: extractFileName(file)
              };
              loaded++;
              if (loaded === files.length) {
                cachedColors[category] = results;
                callback(results);
              }
            });
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      });
    }

    function showPreview(files, containerId) {
      const container = document.getElementById(containerId);
      container.innerHTML = '';
      
      Array.from(files).forEach(file => {
        const reader = new FileReader();
        reader.onload = e => {
          const img = document.createElement('img');
          img.src = e.target.result;
          img.title = file.name;
          container.appendChild(img);
        };
        reader.readAsDataURL(file);
      });
    }

    function generateOutfit() {
      const button = document.getElementById('generar');
      button.classList.add('loading');
      button.textContent = 'Generando...';
      
      setTimeout(() => {
        const refs = document.getElementById('referencias').files;
        if (refs.length === 0) {
          alert("‚ö†Ô∏è Sube al menos una referencia");
          button.classList.remove('loading');
          button.textContent = '‚ú® Generar Outfit';
          return;
        }

        if (cachedColors.camisetas.length === 0 && cachedColors.pantalones.length === 0 && cachedColors.zapatos.length === 0) {
          alert("‚ö†Ô∏è Carga al menos algunas prendas para generar un outfit");
          button.classList.remove('loading');
          button.textContent = '‚ú® Generar Outfit';
          return;
        }

        const randomRefIndex = Math.floor(Math.random() * refs.length);
        const selectedRef = refs[randomRefIndex];

        const reader = new FileReader();
        reader.onload = e => {
          const refImg = new Image();
          refImg.onload = () => {
            getAverageColor(refImg, refColor => {
              const res = document.getElementById('resultado');
              res.innerHTML = "";

              const camisetaSelected = pickBestMatching(cachedColors.camisetas, refColor, 'camisetas');
              
              let pantalonSelected = null;
              if (camisetaSelected) {
                pantalonSelected = pickBestMatching(cachedColors.pantalones, refColor, 'pantalones', (pantalon) => {
                  return !isValidCombination(camisetaSelected.fileName, pantalon.fileName);
                });
              } else {
                pantalonSelected = pickBestMatching(cachedColors.pantalones, refColor, 'pantalones');
              }

              const zapatoSelected = pickBestMatching(cachedColors.zapatos, refColor, 'zapatos');

              if (camisetaSelected) {
                res.innerHTML += `<div class="outfit-item">
                  <h4>üëï Camiseta</h4>
                  <img src="${camisetaSelected.src}">
                  <p><small>${camisetaSelected.fileName}</small></p>
                </div>`;
              }
              
              if (pantalonSelected) {
                res.innerHTML += `<div class="outfit-item">
                  <h4>üëñ Pantal√≥n</h4>
                  <img src="${pantalonSelected.src}">
                  <p><small>${pantalonSelected.fileName}</small></p>
                </div>`;
              }
              
              if (zapatoSelected) {
                res.innerHTML += `<div class="outfit-item">
                  <h4>üëü Zapatos</h4>
                  <img src="${zapatoSelected.src}">
                  <p><small>${zapatoSelected.fileName}</small></p>
                </div>`;
              }

              if (!camisetaSelected && !pantalonSelected && !zapatoSelected) {
                res.innerHTML = "<p>‚ùå No se pudo generar un outfit con las restricciones actuales.</p>";
              }
              
              button.classList.remove('loading');
              button.textContent = '‚ú® Generar Outfit';
            });
          };
          refImg.src = e.target.result;
        };
        reader.readAsDataURL(selectedRef);
      }, 100);
    }

    // Event Listeners
    document.getElementById('camisetas').addEventListener('change', function(e) {
      showPreview(e.target.files, 'preview-camisetas');
      processFiles(e.target.files, 'camisetas', () => {
        console.log(`‚úÖ ${e.target.files.length} camisetas procesadas`);
      });
    });

    document.getElementById('pantalones').addEventListener('change', function(e) {
      showPreview(e.target.files, 'preview-pantalones');
      processFiles(e.target.files, 'pantalones', () => {
        console.log(`‚úÖ ${e.target.files.length} pantalones procesados`);
      });
    });

    document.getElementById('zapatos').addEventListener('change', function(e) {
      showPreview(e.target.files, 'preview-zapatos');
      processFiles(e.target.files, 'zapatos', () => {
        console.log(`‚úÖ ${e.target.files.length} zapatos procesados`);
      });
    });

    document.getElementById('referencias').addEventListener('change', function(e) {
      showPreview(e.target.files, 'preview-referencias');
      processFiles(e.target.files, 'referencias', () => {
        console.log(`‚úÖ ${e.target.files.length} referencias procesadas`);
      });
    });

    document.getElementById('generar').addEventListener('click', generateOutfit);
    
    document.getElementById('resetear').addEventListener('click', function() {
      usageCounter = {
        camisetas: {},
        pantalones: {},
        zapatos: {}
      };
      recentSelections = {
        camisetas: [],
        pantalones: [],
        zapatos: []
      };
      alert('Sistema de rotaci√≥n reseteado. Empezar√° fresh la distribuci√≥n equitativa.');
    });
  </script>
</body>
</html>